var $=Object.defineProperty;var Y=(t,e,r)=>e in t?$(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var x=(t,e,r)=>Y(t,typeof e!="symbol"?e+"":e,r);import{c as Z,j as s,d as f,P as T,B as c,S as b,T as l,x as N,L as J,v as S,aa as Q,w as j,F as X}from"./index-jKwuRwNn.js";import{P as ee}from"./PageHeader-mS0u6ESk.js";import{S as te}from"./SciDataGrid-bmo_bXao.js";import{C as W}from"./CircularProgress-DjKOEO3Z.js";import{T as se,a as k}from"./Tabs-Du2KFX4h.js";import{A as _}from"./Alert-BMTyMOmt.js";import{u as G,s as y,a as re,b as F,c as D,d as I,e as E,f as ne,g as ae,h as A}from"./ContextProvider-DVcfU6wB.js";import{M as w}from"./MenuItem-CE1hZsn1.js";import{b as ie}from"./FilterField-Cib3C2ZA.js";import{a as oe,C as le}from"./DataGrid-D6L07F7c.js";import"./Grid-DPWVtlsw.js";import"./dividerClasses-DZmn6uHW.js";import"./DatePicker-B1Qpyd8t.js";import"./DateCalendar-Cg6vyFpj.js";import"./colorManipulator-CVjwf_SF.js";import"./useGridRootProps-BgQpwyQo.js";import"./Divider-CQ9Z9t6a.js";const d=[];for(let t=0;t<256;++t)d.push((t+256).toString(16).slice(1));function ce(t,e=0){return(d[t[e+0]]+d[t[e+1]]+d[t[e+2]]+d[t[e+3]]+"-"+d[t[e+4]]+d[t[e+5]]+"-"+d[t[e+6]]+d[t[e+7]]+"-"+d[t[e+8]]+d[t[e+9]]+"-"+d[t[e+10]]+d[t[e+11]]+d[t[e+12]]+d[t[e+13]]+d[t[e+14]]+d[t[e+15]]).toLowerCase()}let z;const ue=new Uint8Array(16);function de(){if(!z){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");z=crypto.getRandomValues.bind(crypto)}return z(ue)}const he=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),U={randomUUID:he};function pe(t,e,r){var p;t=t||{};const o=t.random??((p=t.rng)==null?void 0:p.call(t))??de();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,ce(o)}function P(t,e,r){return U.randomUUID?U.randomUUID():pe(t)}class L extends Error{constructor(r){super(r.message);x(this,"code");x(this,"data");this.name="JSONRPCError",this.code=r.code,this.data="data"in r?r.data:"error"in r?r.error:void 0}}class M{constructor(e){x(this,"url");x(this,"token");x(this,"timeout");x(this,"version");this.url=e.url,this.token=e.token,this.timeout=e.timeout||3e4,this.version=e.version||"2.0"}async call(e,r){const o=this.version==="1.1"?{version:"1.1",method:e,id:P(),params:r?[r]:[]}:{jsonrpc:"2.0",method:e,id:P(),params:r},p={"Content-Type":"application/json",Accept:"application/json"};this.token&&(p.Authorization=this.token);const m=new AbortController,a=setTimeout(()=>m.abort(),this.timeout);try{const n=await fetch(this.url,{method:"POST",headers:p,body:JSON.stringify(o),signal:m.signal});if(clearTimeout(a),!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const u=await n.json();if(u.error)throw new L(u.error);return"version"in u&&u.version==="1.1"?u.result[0]:u.result}catch(n){throw clearTimeout(a),n instanceof L?n:n instanceof Error?n.name==="AbortError"?new Error("Request timeout"):n:new Error("Unknown error occurred")}}setToken(e){this.token=e}clearToken(){this.token=void 0}}class me{constructor(e,r){x(this,"client");this.client=new M({url:e,token:r,timeout:3e4,version:"1.1"})}async getServiceStatus(e){return this.client.call("ServiceWizard.get_service_status",e)}setToken(e){this.client.setToken(e)}clearToken(){this.client.clearToken()}}class xe{constructor(e,r){x(this,"client",null);x(this,"serviceWizard");x(this,"token");x(this,"cachedServiceURL");this.token=r,this.serviceWizard=new me(e,r)}async ensureClient(){if(!this.client||!this.cachedServiceURL){const e=await this.serviceWizard.getServiceStatus({module_name:"JobBrowserBFF",version:null}),r=new URL(e.url);this.cachedServiceURL=r.pathname,this.client=new M({url:this.cachedServiceURL,token:this.token,timeout:3e4})}return this.client}setToken(e){this.token=e,this.serviceWizard.setToken(e),this.client&&this.client.setToken(e)}clearToken(){this.token=void 0,this.serviceWizard.clearToken(),this.client&&this.client.clearToken()}async queryJobs(e){return(await this.ensureClient()).call("JobBrowserBFF.query_jobs",e)}async getJobs(e){return(await this.ensureClient()).call("JobBrowserBFF.get_jobs",e)}async getJobLog(e){return(await this.ensureClient()).call("JobBrowserBFF.get_job_log",e)}async cancelJob(e){return(await this.ensureClient()).call("JobBrowserBFF.cancel_job",e)}async getClientGroups(){return(await this.ensureClient()).call("JobBrowserBFF.get_client_groups",{})}async isAdmin(){return(await this.ensureClient()).call("JobBrowserBFF.is_admin",{})}}function ge(t){const e=Date.now();return{from:e-t*24*60*60*1e3,to:e}}function C(t){return new Date(t).toLocaleString()}function O(t){switch(t){case"create":return"#9e9e9e";case"queue":return"#2196f3";case"run":return"#ff9800";case"complete":return"#4caf50";case"error":return"#f44336";case"terminate":return"#9c27b0";default:return"#757575"}}const q=Z(s.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),ve=({job:t,onClose:e,apiClient:r})=>{const[o,p]=f.useState(0),m=[{label:"Job ID",value:t.job_id},{label:"Status",value:t.state.status.toUpperCase()},{label:"Owner",value:`${t.owner.realname} (${t.owner.username})`},{label:"Type",value:t.type},{label:"Node Class",value:t.node_class},{label:"Client Group",value:t.state.client_group},{label:"Created At",value:C(t.state.create_at)}];"queue_at"in t.state&&m.push({label:"Queued At",value:C(t.state.queue_at)}),"run_at"in t.state&&m.push({label:"Run At",value:C(t.state.run_at)}),"finish_at"in t.state&&m.push({label:"Finished At",value:C(t.state.finish_at)});const a=t.app?[{label:"App ID",value:t.app.id},{label:"Title",value:t.app.title},{label:"Module",value:t.app.module_name},{label:"Function",value:t.app.function_name},{label:"Type",value:t.app.type}]:[],n=[{label:"Type",value:t.context.type}];return(t.context.type==="narrative"||t.context.type==="workspace")&&(n.push({label:"Workspace ID",value:String(t.context.workspace.id)}),n.push({label:"Workspace Name",value:t.context.workspace.name}),n.push({label:"Accessible",value:t.context.workspace.is_accessible?"Yes":"No"}),n.push({label:"Deleted",value:t.context.workspace.is_deleted?"Yes":"No"}),t.context.type==="narrative"&&(n.push({label:"Narrative Title",value:t.context.narrative.title||"Untitled"}),n.push({label:"Temporary",value:t.context.narrative.is_temporary?"Yes":"No"}))),s.jsxs(T,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[s.jsxs(c,{sx:{padding:2,borderBottom:1,borderColor:"divider"},children:[s.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[s.jsx(l,{variant:"h6",children:"Job Details"}),s.jsx(N,{size:"small",onClick:e,children:s.jsx(q,{})})]}),s.jsx(W,{label:t.state.status.toUpperCase(),size:"small",sx:{backgroundColor:O(t.state.status),color:"white",fontWeight:"bold",marginTop:1}})]}),s.jsxs(se,{value:o,onChange:(u,g)=>p(g),children:[s.jsx(k,{label:"Details"}),s.jsx(k,{label:"App",disabled:!t.app}),s.jsx(k,{label:"Context"}),t.state.status==="error"&&s.jsx(k,{label:"Error"})]}),s.jsxs(c,{sx:{padding:2,overflow:"auto",flex:1},children:[o===0&&s.jsx(J,{rows:m}),o===1&&t.app&&s.jsx(J,{rows:a}),o===2&&s.jsx(J,{rows:n}),o===3&&t.state.status==="error"&&s.jsx(c,{children:t.state.status==="error"&&s.jsxs(_,{severity:"error",children:[s.jsxs(l,{variant:"subtitle2",children:["Error Code: ",t.state.error.code]}),s.jsx(l,{variant:"body2",sx:{marginTop:1},children:t.state.error.message})]})}),t.state.status==="terminate"&&s.jsx(c,{sx:{marginTop:2},children:s.jsxs(_,{severity:"warning",children:[s.jsxs(l,{variant:"subtitle2",children:["Termination Code: ",t.state.reason.code]}),t.state.reason.message&&s.jsx(l,{variant:"body2",sx:{marginTop:1},children:t.state.reason.message})]})}),(t.state.status==="run"||t.state.status==="queue")&&r&&s.jsx(c,{sx:{marginTop:2},children:s.jsx(S,{variant:"outlined",color:"error",fullWidth:!0,onClick:async()=>{try{await r.cancelJob({job_id:t.job_id,timeout:3e4,admin:!1}),alert("Job cancellation requested")}catch(u){const g=u instanceof Error?u.message:"Failed to cancel job";alert(`Error: ${g}`)}},children:"Cancel Job"})})]})]})},fe=({onClose:t})=>{const{state:e,dispatch:r}=G(),o=["create","queue","run","complete","error","terminate"],p=(a,n)=>{const u=e.filter.status||[],g=n?[...u,a]:u.filter(B=>B!==a);r(y({status:g.length>0?g:void 0}))},m=a=>{r(re(a))};return s.jsxs(T,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[s.jsx(c,{sx:{padding:2,borderBottom:1,borderColor:"divider"},children:s.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[s.jsx(l,{variant:"h6",children:"Filters"}),s.jsx(N,{size:"small",onClick:t,children:s.jsx(q,{})})]})}),s.jsx(c,{sx:{padding:2,overflow:"auto",flex:1},children:s.jsxs(b,{spacing:3,children:[s.jsxs(c,{children:[s.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Time Range"}),s.jsxs(Q,{value:e.timeRangeDays,onChange:a=>m(Number(a.target.value)),size:"small",fullWidth:!0,children:[s.jsx(w,{value:1,children:"Last 24 hours"}),s.jsx(w,{value:3,children:"Last 3 days"}),s.jsx(w,{value:7,children:"Last 7 days"}),s.jsx(w,{value:14,children:"Last 14 days"}),s.jsx(w,{value:30,children:"Last 30 days"}),s.jsx(w,{value:90,children:"Last 90 days"})]})]}),s.jsxs(c,{children:[s.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Job Status"}),s.jsx(ie,{children:o.map(a=>{var n;return s.jsx(oe,{control:s.jsx(le,{checked:((n=e.filter.status)==null?void 0:n.includes(a))||!1,onChange:u=>p(a,u.target.checked),size:"small"}),label:a.toUpperCase()},a)})})]}),s.jsxs(c,{children:[s.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Job ID"}),s.jsx(j,{placeholder:"Enter job ID",size:"small",fullWidth:!0,onChange:a=>{const n=a.target.value.trim();r(y({job_id:n?[n]:void 0}))}}),s.jsx(l,{variant:"caption",color:"text.secondary",children:"Filter by specific job ID"})]}),s.jsxs(c,{children:[s.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Username"}),s.jsx(j,{placeholder:"Enter username",size:"small",fullWidth:!0,onChange:a=>{const n=a.target.value.trim();r(y({user:n?[n]:void 0}))}}),s.jsx(l,{variant:"caption",color:"text.secondary",children:"Filter by job owner"})]}),s.jsxs(c,{children:[s.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"App Module"}),s.jsx(j,{placeholder:"Enter app module name",size:"small",fullWidth:!0,onChange:a=>{const n=a.target.value.trim();r(y({app_module:n?[n]:void 0}))}}),s.jsx(l,{variant:"caption",color:"text.secondary",children:"Filter by app module"})]}),s.jsxs(c,{children:[s.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Client Group"}),s.jsx(j,{placeholder:"Enter client group",size:"small",fullWidth:!0,onChange:a=>{const n=a.target.value.trim();r(y({client_group:n?[n]:void 0}))}}),s.jsx(l,{variant:"caption",color:"text.secondary",children:"Filter by client group"})]})]})}),s.jsx(c,{sx:{padding:2,borderTop:1,borderColor:"divider"},children:s.jsxs(l,{variant:"caption",color:"text.secondary",children:["Active Filters:"," ",Object.keys(e.filter).filter(a=>e.filter[a]).length||"None"]})})]})},be="/services/service_wizard",Pe=function(){const{state:e,dispatch:r}=G(),[o,p]=f.useState(""),[m,a]=f.useState(!0),[n,u]=f.useState(null),g=f.useRef(!1);f.useEffect(()=>{if(e.token){const i=new xe(be,e.token);u(i)}else u(null)},[e.token]);const B=f.useMemo(()=>JSON.stringify(e.filter),[e.filter]);f.useEffect(()=>{if(!n||!e.token||g.current)return;(async()=>{g.current=!0,r(F(!0)),r(I(null));try{const h=ge(e.timeRangeDays),v=await n.queryJobs({time_span:h,offset:e.page*e.pageSize,limit:e.pageSize,timeout:3e4,filter:e.filter,sort:[{key:"created",direction:"descending"}]});r(E(v.jobs)),r(ne(v.found_count)),r(ae(v.total_count))}catch(h){const v=h instanceof Error?h.message:"Failed to fetch jobs";r(I(v)),r(E([]))}finally{r(F(!1)),g.current=!1}})()},[n,e.token,e.page,e.pageSize,B,e.timeRangeDays]);const R=()=>{o.trim()&&r(A(o.trim()))},K=()=>{p(""),r(A(null)),r(E([])),r(D(null))},V=i=>{r(D(i.row))},H=[{field:"job_id",headerName:"Job ID",width:180,renderCell:i=>s.jsx(l,{variant:"body2",sx:{fontFamily:"monospace",fontSize:"0.85rem"},children:i.value})},{field:"status",headerName:"Status",width:120,valueGetter:(i,h)=>h.state.status,renderCell:i=>s.jsx(W,{label:i.value.toUpperCase(),size:"small",sx:{backgroundColor:O(i.value),color:"white",fontWeight:"bold"}})},{field:"app",headerName:"App",width:200,valueGetter:(i,h)=>{var v;return((v=h.app)==null?void 0:v.title)||"Unknown"}},{field:"owner",headerName:"Owner",width:150,valueGetter:(i,h)=>h.owner.username},{field:"created",headerName:"Created",width:180,valueGetter:(i,h)=>C(h.state.create_at)},{field:"client_group",headerName:"Client Group",width:150,valueGetter:(i,h)=>h.state.client_group}];return s.jsxs(c,{children:[s.jsx(ee,{pageTitle:"KBase Job Browser",description:"Browse and monitor KBase Narrative jobs using the JobBrowserBFF API",sx:{marginBottom:1,padding:2}}),s.jsxs(c,{sx:{padding:2,paddingTop:0},children:[s.jsx(T,{sx:{padding:2,marginBottom:2},children:s.jsxs(b,{spacing:2,children:[s.jsx(l,{variant:"h6",children:"Authentication"}),s.jsxs(b,{direction:"row",spacing:2,alignItems:"center",children:[s.jsx(j,{label:"KBase Token",type:"password",value:o,onChange:i=>p(i.target.value),onKeyPress:i=>{i.key==="Enter"&&R()},disabled:!!e.token,fullWidth:!0,size:"small",helperText:"Enter your KBase authentication token to access jobs"}),e.token?s.jsx(S,{variant:"outlined",onClick:K,color:"error",children:"Disconnect"}):s.jsx(S,{variant:"contained",onClick:R,disabled:!o.trim(),children:"Connect"})]}),e.token&&s.jsxs(_,{severity:"success",children:["Connected to KBase API. Showing jobs from the last"," ",e.timeRangeDays," days (~",Math.round(e.timeRangeDays/365)," years)."]})]})}),e.error&&s.jsx(_,{severity:"error",sx:{marginBottom:2},children:e.error}),e.token&&s.jsxs(b,{direction:"row",spacing:2,children:[m&&s.jsx(c,{sx:{width:"350px",flexShrink:0},children:s.jsx(fe,{onClose:()=>a(!1),apiClient:n})}),s.jsxs(T,{elevation:0,sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column"},children:[e.loading&&s.jsx(X,{}),s.jsxs(c,{sx:{padding:2,display:"flex",flexDirection:"column",flex:1},children:[s.jsxs(b,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:1,children:[s.jsxs(l,{variant:"body2",color:"text.secondary",children:["Showing ",e.jobs.length," of ",e.foundCount," jobs (",e.totalCount," total in time range)"]}),!m&&s.jsx(S,{size:"small",onClick:()=>a(!0),children:"Show Filters"})]}),s.jsx(c,{sx:{flex:1},children:s.jsx(te,{rows:e.jobs,columns:H,getRowId:i=>i.job_id,loading:e.loading,pageSizeOptions:[10,20,50,100],paginationModel:{page:e.page,pageSize:e.pageSize},onPaginationModelChange:i=>{r(F(!1)),i.page!==e.page&&r({type:"SET_PAGE",payload:i.page}),i.pageSize!==e.pageSize&&r({type:"SET_PAGE_SIZE",payload:i.pageSize})},rowCount:e.foundCount,paginationMode:"server",onRowClick:V,rowHeight:52,sx:{height:"100%","& .MuiDataGrid-row":{cursor:"pointer"}}})})]})]}),e.selectedJob&&s.jsx(c,{sx:{width:"400px",flexShrink:0},children:s.jsx(ve,{job:e.selectedJob,onClose:()=>r(D(null)),apiClient:n})})]})]})]})};export{Pe as component};
